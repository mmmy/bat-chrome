<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebSocket Test Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .log {
      background: #f5f5f5;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      height: 300px;
      overflow-y: auto;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <h1>WebSocket Test Page</h1>
  <p>This page simulates the BatChat WebSocket connection for testing the Chrome extension.</p>

  <button id="connectBtn">Connect to WebSocket</button>
  <button id="disconnectBtn">Disconnect</button>
  <button id="sendBtn">Send Test Message</button>

  <div id="status" class="status disconnected">Disconnected</div>

  <h3>Message Log:</h3>
  <div id="log" class="log"></div>

  <script>
    let ws = null;
    const logDiv = document.getElementById('log');
    const statusDiv = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');

    function log(message) {
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${time}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(connected) {
      if (connected) {
        statusDiv.textContent = 'Connected to WebSocket';
        statusDiv.className = 'status connected';
      } else {
        statusDiv.textContent = 'Disconnected';
        statusDiv.className = 'status disconnected';
      }
    }

    connectBtn.addEventListener('click', function() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        log('Already connected');
        return;
      }

      // Connect to the WebSocket URL (simulate BatChat's WebSocket)
      ws = new WebSocket('wss://wsd.baaaat.com/ws');

      ws.onopen = function() {
        log('WebSocket connection opened');
        updateStatus(true);
      };

      ws.onmessage = function(event) {
        log(`Received message (base64): ${event.data}`);
        try {
          const decoded = atob(event.data);
          log(`Decoded message: ${decoded}`);
        } catch (e) {
          log('Failed to decode message (not base64?)');
        }
      };

      ws.onclose = function() {
        log('WebSocket connection closed');
        updateStatus(false);
      };

      ws.onerror = function(error) {
        log(`WebSocket error: ${error}`);
        updateStatus(false);
      };
    });

    disconnectBtn.addEventListener('click', function() {
      if (ws) {
        ws.close();
        ws = null;
      }
    });

    sendBtn.addEventListener('click', function() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        // Create a test message and encode it in base64
        const testMessage = JSON.stringify({
          type: 'test',
          message: 'Hello from test page',
          timestamp: Date.now()
        });
        const encoded = btoa(testMessage);
        ws.send(encoded);
        log(`Sent test message: ${testMessage}`);
      } else {
        log('Not connected to WebSocket');
      }
    });

    // Simulate receiving messages every 5 seconds when connected
    setInterval(function() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        // Simulate a received message
        const simulatedMessage = {
          type: 'chat',
          user: 'test_user',
          content: 'This is a simulated message ' + Math.random(),
          timestamp: Date.now()
        };
        const encoded = btoa(JSON.stringify(simulatedMessage));

        // Trigger the message event
        const event = new MessageEvent('message', { data: encoded });
        ws.onmessage(event);
      }
    }, 5000);
  </script>
</body>
</html>